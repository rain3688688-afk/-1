import { useState, useEffect, useRef } from 'react';
import { createClient } from '@supabase/supabase-js';
import Head from 'next/head';

// ==========================================
// 1. 配置 & 工具
// ==========================================

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);

const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// ==========================================
// 2. 核心数据 (完整版)
// ==========================================

const DIM_MAP = {
  1: { id: 1, label: "确定感", color: "#E7E5E4", totem: "深扎的树根 / 磐石" },
  2: { id: 2, label: "被需要", color: "#FB923C", totem: "温顺的金毛 / 壁炉之火" },
  3: { id: 3, label: "掌控感", color: "#94A3B8", totem: "高速公路 / 船长" },
  4: { id: 4, label: "被偏爱", color: "#FB7185", totem: "被驯服的狐狸 / 草莓尖尖" },
  5: { id: 5, label: "精神共鸣", color: "#818CF8", totem: "互映的镜子 / 深夜书房" },
  6: { id: 6, label: "自由感", color: "#38BDF8", totem: "飘浮的云 / 落地窗" },
  7: { id: 7, label: "安全距离", color: "#34D399", totem: "林间小鹿 / 降噪耳机" },
  8: { id: 8, label: "秩序感", color: "#60A5FA", totem: "囤粮松鼠 / 契约" }
};

const RESULTS = {
  1: {
    title: "确定感",
    keyword: "风暴中的守夜人",
    quote: "万物皆流变，而我只要一种绝对的定数。",
    sections: [
      { t: "你的亲密底色", c: "在亲密关系中，你核心的情感诉求是“稳定与可预期”。你对“凡事有交代、件件有着落”有着近乎执着的追求。这并非控制，而是你构建安全感的基石。你对不确定性极度敏感，所有的追问和确认，本质上都是为了在流动的关系中寻找一个稳定的锚点。" },
      { t: "你的光：天赋优势", c: "你是关系中的定海神针。你拥有极强的抗风险韧性，不会因短期波动轻易放弃。你的情感投入具有极强的排他性，一旦认定便是毫无保留的忠诚。面对裂痕，你倾向于修复而非逃避，始终以长久为目标。" },
      { t: "你的影：隐性挑战", c: "你难以忍受信息的空白，容易将沉默或延迟回应解读为“被否定”。常常以“懂事”为名压抑自己的需求，因恐惧成为负担而独自消化不安。对未来的焦虑性预判，常阻碍你享受当下的快乐。" },
      { t: "给爱你的TA", c: "1. 别嫌我不停追问，我只是在求一份安心，抱抱我就好。\n2. 忙的时候提前说一声，你的报备是我的定心丸。\n3. 关键时刻请坚定地偏向我，任何犹豫都会被我解读为“我不重要”。" },
      { t: "深度溯源", c: "这往往源于早期依恋模式中，照顾者回应的不稳定性。这种不可预测的环境让你时刻紧绷神经，唯恐爱突然消失。你执着于确定感，是为了填补童年那份从未被满足的安全渴求。" },
      { t: "自我重塑", c: "试着停止对模糊信号的灾难化解读。爱不是持续的电流，而是有蓄电功能的电池，偶尔的间隙不会导致断裂。建立独立于关系的快乐来源，把情绪重心收回。" },
      { t: "祝福", c: "愿你遇见一个懂你不安的人，他不必许你永远，却能在你慌张时给你笃定。更愿你明白，最恒久的确定感，从不来自外界的安稳，而源于你内心的从容。" }
    ]
  },
  2: {
    title: "被需要",
    keyword: "温情的守护者",
    quote: "没有你，我只是一片废墟。",
    sections: [
      { t: "你的亲密底色", c: "你的爱是实打实的“我能为你做什么”。比起甜言蜜语，你更在意自己的存在能让对方生活变轻松。你潜意识里认为“被依赖”才意味着“不可替代”。若对方不麻烦你，你会感到空落，甚至怀疑自我价值。" },
      { t: "你的光：天赋优势", c: "你是最踏实的后盾，总能敏锐捕捉到对方未说出口的疲惫与需求。你的付出充满温度，能让对方真切感受到“我不是一个人在扛”。同时，你清醒地追求互惠平衡，渴望双向的奔赴。" },
      { t: "你的影：隐性挑战", c: "你常把价值感绑定在“被需要”上，一旦对方独立，你就觉得自己多余。不敢直说“我也想被照顾”，宁愿默默付出等对方发现，最后演变成委屈。容易过度承担，把自己累垮。" },
      { t: "给爱你的TA", c: "1. 当我帮忙时，别说“不用”，你的接受是对我价值的肯定。\n2. 主动向我求助，或者让我帮你煮碗面，这比情话更让我有安全感。\n3. 告诉我“你需要的是我这个人，而不是我的付出”。" },
      { t: "深度溯源", c: "这往往源于“懂事才能被爱”的童年体验。或许你从小就学会了察言观色、照顾家人以换取关注。久而久之，“有用”成了你获取爱的唯一路径。你拼命付出，只是为了确认自己值得被爱。" },
      { t: "自我重塑", c: "先学会不付出也敢安心被爱。对方能独立是好事，你的存在本身就珍贵。坦然说出“我也需要照顾”，不用硬撑万能者。拓展自我价值，不再仅通过伴侣的依赖来定义自己。" },
      { t: "祝福", c: "愿你遇见一个既珍惜你付出，又主动为你分担的人。愿你不用靠“有用”换取存在感，哪怕什么都不做，也能坦然相信：我值得被好好爱着。" }
    ]
  },
  3: {
    title: "掌控感",
    keyword: "并肩的掌舵者",
    quote: "我抛开了所有理智，只求你结束我的痛苦。",
    sections: [
      { t: "你的亲密底色", c: "你渴望的不是控制，而是关系的可预期与协同。亲密关系对你像一艘船，必须校准航向、明确规则。模糊的界限和反复的态度是你眼中的隐患，你被迫站出来当“大人”，只因恐惧无序带来的失控感。" },
      { t: "你的光：天赋优势", c: "你拥有清晰的关系梳理力，擅长将模糊的期待转化为共识。面对问题从不逃避，行动力强，能推动关系突破卡点。你是最靠谱的托底者，早已为“一起走下去”铺好了路。" },
      { t: "你的影：隐性挑战", c: "对无序有极致焦虑，一旦脱轨就容易惊慌。长期独自掌舵让你身心俱疲，却不敢放手。容易用理性掩盖情绪，习惯了先解决问题，却忽略了自己也需要被安慰。" },
      { t: "给爱你的TA", c: "1. 我不是想控制你，只是怕关系乱了阵脚，我想和你一起捋顺它。\n2. 请告诉我你的想法，别让我一个人猜，我要的是合作感。\n3. 偶尔提醒我：先不急解决问题，单纯陪陪我就好。" },
      { t: "深度溯源", c: "这源于童年无序环境下的生存本能。或许小时候身边缺乏规则，遇事没人托底，你被迫学会了自己站出来建立秩序。只有把局面抓在手里，才能抵御那种惊慌失措的不安。" },
      { t: "自我重塑", c: "接纳适度失控，关系不必像精密仪器般精准。放下全能责任，学会把担子分出去，依赖对方也是一种能力。允许自己暴露脆弱，承认“我搞不定”不是软弱，而是真实的连接。" },
      { t: "祝福", c: "愿你遇见一个能和你并肩扛事的人，不用再独自做那个“负责全局的大人”。愿你拥有掌舵的底气，也有安心被照顾的福气。" }
    ]
  },
  4: {
    title: "被偏爱",
    keyword: "独特的例外",
    quote: "你要永远为你驯服的东西负责。",
    sections: [
      { t: "你的亲密底色", c: "你的安全感扎根于“例外感”。你不在意他对别人好，但如果在你这里没有“特殊待遇”，你的情绪会瞬间紧绷。你需要从微妙的差别对待中，反复确认“我在你心里有独属位置”。" },
      { t: "你的光：天赋优势", c: "认定一人便全身心投入，爱得深情且坚定。你心思细腻，能捕捉到对方被忽略的需求，让关系充满温度。你擅长创造专属记忆，让这段关系变得独一无二、深刻动人。" },
      { t: "你的影：隐性挑战", c: "对差别对待极致敏感，常因对方的一个忽略而陷入内耗。一旦感觉不再特别，会下意识收回深情作为防御。容易将小事放大为“我不重要”的信号。" },
      { t: "给爱你的TA", c: "1. 我要的不是更多，而是“独一份”的用心。\n2. 别说我想太多，先抱抱我，承认你在乎我的感受。\n3. 主动表达偏爱是我的刚需，请在选择时优先考虑我。" },
      { t: "深度溯源", c: "源于童年渴望“被优先选择”的缺失。或许你的需求常被排在后面，关注被分摊。那些稀缺的特殊对待成了你对爱的核心定义。你执着于偏爱，是想补上童年没被坚定选择的遗憾。" },
      { t: "自我重塑", c: "接纳敏感，它不是缺点。先学会自己偏爱自己，不必依赖外界证明。直白表达需求，告诉对方如何爱你，而不是让他猜来猜去。" },
      { t: "祝福", c: "愿你遇见明目张胆的偏爱，清楚感受到自己是不可替代的例外。更愿你自带底气，往后余生，被爱眷顾，更被自己深爱。" }
    ]
  },
  5: {
    title: "精神共鸣",
    keyword: "灵魂的同频者",
    quote: "我们相遇在精神的旷野，无需言语便已相通。",
    sections: [
      { t: "你的亲密底色", c: "你渴求的是灵魂层面的同频共振。日常的寒暄无法满足你，你追求的是“懂”——思维的契合与精神的吸引。没有思想交流的关系对你而言只是空壳，你怕的不是孤独，而是两个人在一起却灵魂断连。" },
      { t: "你的光：天赋优势", c: "你为关系注入思想活力，带领彼此共同探索世界。具备深层共情的理解力，能读懂对方未说出口的情绪。和你在一起永远有新灵感，关系不会陷入枯燥重复。" },
      { t: "你的影：隐性挑战", c: "对浅层关系耐受度极低，容易因聊不到一块而感到“不在意”。精神错位敏感度高，一旦频率不合便迅速失去热情。有时因执着于深刻，而忽略了日常琐碎幸福的价值。" },
      { t: "给爱你的TA", c: "1. 别只聊琐事，和我分享你真实的思考，哪怕只是困惑。\n2. 当我聊起“无用”的话题，其实是在递出靠近灵魂的信号。\n3. 不必懂深奥理论，只要别敷衍我的认真，哪怕只是倾听。" },
      { t: "深度溯源", c: "源于童年“想太多却没人懂”的孤独。或许你从小就心思细腻、爱思考，却被大人视为“怪”或“没用”。那份没人听完的话，演变成了对“精神同频”的极致渴望，只想找个不用解释就能懂你的人。" },
      { t: "自我重塑", c: "接纳你的深度需求，这是你独特的天赋。不要把所有精神需求压在一个人身上，允许灵魂“多元栖息”。学会在普通日子里发现连接，平淡的陪伴同样是滋养。" },
      { t: "祝福", c: "愿你遇见共赴精神旷野的伙伴，愿意听你说完所有奇思妙想。你的思考与独特，本身就是最珍贵的礼物，无需向谁证明。" }
    ]
  },
  6: {
    title: "自由感",
    keyword: "自在的并行者",
    quote: "我爱你，却不愿用爱束缚你。",
    sections: [
      { t: "你的亲密底色", c: "你的核心需求是“在爱里守住自我”。你愿意亲密，但必须保留完全属于自己的空间。任何过度的关注、捆绑或要求，都会让你本能后退。你理想的爱是：我需要时你在，我想独处时你不扰。" },
      { t: "你的光：天赋优势", c: "你自带让人舒展的松弛感，不紧绷、不控制。拥有清晰的边界感，尊重彼此的独立性。你有很强的自我负责能力，不把情绪包袱甩给对方，爱得轻盈而不沉重。" },
      { t: "你的影：隐性挑战", c: "对“过度靠近”本能抗拒，易让对方觉得“不够爱”。习惯独自消化情绪，导致对方感觉走不进你心里。清淡的表达方式容易引发误解，让关系陷入猜疑。" },
      { t: "给爱你的TA", c: "1. 我需要独处是为了回血，调整好状态才能更好地爱你。\n2. 别用时刻在线检验我，那只会让我窒息想逃。\n3. 当我告诉你我的安排，其实是在把你放进我的生活里。" },
      { t: "深度溯源", c: "源于童年对“失去自我”的恐惧。或许你从小就被要求“听话”，生活被严密管束，想法常被否定。你只有守住边界才能保护真实的自己。你拼命要的自由，本质是想被尊重：不用迎合谁，也能被爱。" },
      { t: "自我重塑", c: "接纳边界需求，这从不是冷漠。温柔地划定边界，主动告知你的节奏，而不是等越界了再后退。试着适度敞开，偶尔分享脆弱，让对方知道你只是需要时间，而非推开。" },
      { t: "祝福", c: "愿你保有做自己的勇气，遇见懂你节奏的人。你们是并行的光，各自独立，却在需要时相互照亮。在爱里自在呼吸，在自我里闪闪发光。" }
    ]
  },
  7: {
    title: "安全距离",
    keyword: "审慎的慢热者",
    quote: "待人如执烛，太近灼手，太远暗生。",
    sections: [
      { t: "你的亲密底色", c: "你的靠近是“安全第一”。你不是冷淡，只是自带“安全缓冲带”，必须反复确认无刺痛才敢前行。你对“来得快”的热情本能警觉，只因太怕交付真心后被辜负。一旦认定，你比谁都长情。" },
      { t: "你的光：天赋优势", c: "你是最让人安心的定心丸，不轻易开始，但开始后绝对坚定。你懂得拿捏“刚刚好”的距离，让关系亲疏有度。情绪克制稳健，总能用理性化解矛盾，避免无谓内耗。" },
      { t: "你的影：隐性挑战", c: "你的慢热常与他人的快节奏错位，导致“不被读懂”的孤独。一旦被催促就会防御性退缩，把关系推远。总在观察期反复纠结，容易陷入无限内耗，不敢迈出关键一步。" },
      { t: "给爱你的TA", c: "1. 我的慢不是没感觉，是怕真心错付。别催我，让我慢慢把关系走稳。\n2. 别带情绪逼问我，放下评判听我说，我才会卸下防备。\n3. 持续靠谱的踏实感，比一次性的盛大更让我安心。" },
      { t: "深度溯源", c: "源于早年“靠近即受伤”的体验。或许你的真心曾被嘲笑、辜负，或在情绪失控的大人面前战战兢兢。你学会了“不轻易伸手就不会被伤”。你的慢，只是在反复确认：这个人，真的安全吗？" },
      { t: "自我重塑", c: "接纳自己的节奏，你有权利慢慢来。试着小步敞开，从分享微小的情绪开始，不必一步到位。直白说出“我需要时间”，清晰的表达能减少对方的误解和你的焦虑。" },
      { t: "祝福", c: "愿你遇见那个愿意等你的人，他能读懂你慢热背后的赤诚。终有一天，你能在真正安全的关系里告诉自己：这次，我可以试着比从前再靠近一点点。" }
    ]
  },
  8: {
    title: "秩序感",
    keyword: "清醒的共建者",
    quote: "好的关系，是一起把日子过成有章法的温柔。",
    sections: [
      { t: "你的亲密底色", c: "你追求的是“有章法的温柔”。你认定长期关系的根基是清晰的边界和明确的共识。你无法忍受模糊和混乱，焦虑于猜忌和悬而未决的矛盾。你要的不是浪漫，而是两人并肩把日子过稳的笃定。" },
      { t: "你的光：天赋优势", c: "拥有化繁为简的能力，能将混乱的关系捋顺，避开内耗。遇事主动沟通破局，不把矛盾留过夜。自带长远视角，擅长规划未来，给关系最实实在在的支撑。" },
      { t: "你的影：隐性挑战", c: "对模糊状态零容忍，一旦对方态度暧昧就极度焦虑。急于解决问题而忽略了情绪缓冲，容易被认为太理智。对回避沟通的人极易失去耐心，因反复消耗而疲惫。" },
      { t: "给爱你的TA", c: "1. 坦诚沟通本身就是最踏实的爱，我想和你少些内耗。\n2. 别用“顺其自然”敷衍我，长时间的模糊会耗光我的安全感。\n3. 当我提议聊聊时，请认真对待，这是我在试图修复关系。" },
      { t: "深度溯源", c: "源于童年对“没个准数”的恐慌。或许曾经历承诺落空、规则朝令夕改、遇事没人牵头的混乱。你发现只有自己建立秩序才踏实。这份秩序感，是你捂热不安的方式，是你在混乱中亲手抓住的救命稻草。" },
      { t: "自我重塑", c: "你的秩序需求是珍贵的能力，不必苛责。分清问题和情绪，先接住对方的感受，再谈解决方案。允许关系有暂时的留白，只要看到对方的诚意，偶尔慢一点也没关系。" },
      { t: "祝福", c: "愿你遇见不回避问题、愿和你把话捋顺的同行者。你的清晰与原则是礼物。有章法的相处少内耗，这份踏实的温暖，是你最长久的幸福。" }
    ]
  }
};

const QUESTIONS = [
  // Part 1: 现实切片
  { id: 1, text: "周末下午，伴侣突然失联了3个小时，发消息也没回。那一刻，你最真实的反应是？", opts: [{t: "下意识地去翻聊天记录，看是不是我说错话了？这种未知最折磨人。", v: 1}, {t: "挺好的，刚好没人管我。我可以专心做自己的事，不用一直切出去回消息。", v: 6}, {t: "第一反应是推测原因，准备等联系上后，哪怕不吵架，也要问清楚去向，防止下次再这样。", v: 3}, {t: "心里会有点堵得慌。也不是多大事，就是觉得如果他够在意我，怎么舍得让我空等这么久？", v: 4}] },
  { id: 2, text: "伴侣最近工作压力极大，回到家情绪很低落，坐在沙发上一言不发。此时你心里最真实的念头是？", opts: [{t: "看着挺心疼的。我不一定能帮上忙，但至少给他倒杯水、切点水果，让他知道身边有人照顾着。", v: 2}, {t: "他现在应该很烦，不想说话。那我就识趣点，躲远点玩手机，别去撞枪口，等他缓过来了再说。", v: 7}, {t: "这种死气沉沉的沉默让我很难受。我还是希望能聊聊，哪怕只说几句，让我知道他脑子里到底在想什么也好。", v: 5}, {t: "我比较在意接下来的安排：今晚是就在家吃还是出去？既然心情不好，原本的计划还作数吗？", v: 8}] },
  { id: 3, text: "因为一件琐事发生了激烈的争吵，甚至有些冷场。你心里那个过不去的点主要是？", opts: [{t: "吵架可以，但能不能别用那种冷冰冰的态度对我？那种好像随时要放弃我的感觉，比吵架本身更让我害怕。", v: 1}, {t: "情绪发泄完了吗？完了我们就复盘一下。到底谁对了谁错了，以后这种情况按谁的来？别稀里糊涂就过去了。", v: 8}, {t: "看他气得脸色发白或者不说话的样子，我突然就心软了。输赢不重要，我甚至想先低头哄哄他。", v: 2}, {t: "这种无法沟通的局面让我很烦躁。如果不立刻把问题解决掉、翻篇，我就没法继续安心做别的事。", v: 3}] },
  { id: 4, text: "你冷不丁冒出一个有点奇怪的脑洞，随口讲给伴侣听。此时你最期待/最真实的反应是？", opts: [{t: "哪怕他没听懂，但只要他愿意放下手机、转过身来认真听我说完这些废话，我就觉得很满足，因为他在乎我。", v: 4}, {t: "他能瞬间接住这个梗，甚至还能顺着我的逻辑延伸出新的观点。那一刻我会觉得“天哪，这个世界上只有你懂我”。", v: 5}, {t: "我不强求他懂，更别为了迎合我而硬聊。我最舒服的状态是：我说我的，你听你的，哪怕观点完全不同也没关系，不必非要强行同步。", v: 6}, {t: "其实我通常只敢说一半。对于那些特别真实、特别私人的怪想法，我还是习惯自己留着，怕说出来对方接不住，反而尴尬。", v: 7}] },
  { id: 5, text: "伴侣想看你的手机，或者询问你过去的详细情感经历。你的本能反应是？", opts: [{t: "哪怕没秘密，我也很反感。这是我的隐私，每个人都该有自己的小世界，这种被审视的感觉让我很不舒服。", v: 6}, {t: "随便看。甚至如果你看了能更安心、更信任我，那我求之不得。我不希望我们之间有任何猜疑。", v: 1}, {t: "看可以，但要公平。如果我也能看你的，或者我们也交换秘密，那就没问题。规则对等就行。", v: 8}, {t: "看可以，但我不想被误解。那些都是过去的事了，我不希望你只盯着几个名字或事件，就片面地定义现在的我。", v: 5}] },
  { id: 6, text: "伴侣偶尔有些迷糊，犯了个不大不小的错（比如买错了东西、记错了时间）。你下意识的第一反应通常是？", opts: [{t: "下意识地去兜底。 看他搞砸了，我第一反应不是生气，而是直接上手帮他善后。", v: 2}, {t: "觉得被忽视了。 第一反应是：“你是不是没把我的事放心上？”如果你足够在意我，就不该犯这种错。", v: 4}, {t: "复盘原因。 我会本能地想知道哪个环节出了问题。这种不在计划内的失误让我很难受，我想确保下次别再发生。", v: 3}, {t: "无所谓。 “谁还没个犯错的时候，多大点事。” 我也不希望如果我犯错了对方揪着不放。大家都轻松点最好。", v: 7}] },
  { id: 7, text: "谈到“未来”这个话题时，什么情况最让你感到不安？", opts: [{t: "没有计划，没有具体打算，就说“顺其自然”。这种没规划的日子让我很没底。", v: 8}, {t: "他的态度不坚定。如果他表现出一丝犹豫，或者说“以后的事以后再说”，我就会怀疑他是不是没打算长久。", v: 1}, {t: "一想到未来几十年都要和一个人绑死，还要面对柴米油盐的琐碎，我就本能地想逃，怕自己会慢慢枯萎。", v: 6}, {t: "我怕未来大家都很忙，各过各的。让我觉得我们不是爱人，而是正在变成两个合租的陌生人。", v: 2}] },
  { id: 8, text: "当你自己情绪崩溃、非常脆弱的时候，你最希望对方做什么？", opts: [{t: "别一直问“怎么了”、“别哭了”。就当没看见，让我自己躲一会儿，等我好了再出来。", v: 7}, {t: "不需要讲道理，也不需要给建议。只要抱着我，让我感觉“这一刻你也一样难过”，我就被治愈了。", v: 5}, {t: "帮我分析一下现在的烂摊子该怎么收场。与其哄我，不如帮我一起把那个搞崩我的问题解决掉。", v: 3}, {t: "就算我无理取闹，也请先站在我这边。别跟我讲客观公正，这时候我只需要偏袒。", v: 4}] },
  { id: 9, text: "到了纪念日或生日，如果伴侣准备的礼物（或安排）让你觉得有点失望，那个失望的点通常是？", opts: [{t: "觉得不够用心。 并不是要多贵，而是这东西随便谁都能买到，完全看不出我是那个被特殊对待的人。", v: 4}, {t: "觉得没意义。 他送的东西跟我完全不搭界，说明他根本不了解我最近在关注什么，也不懂我的喜好。", v: 5}, {t: "觉得不实用或浪费。 这种华而不实的东西，破坏了我们的开销计划，还不如买点家里正缺的实用的。", v: 8}, {t: "觉得不平衡。 我总是习惯把你的喜好记在备忘录里，但你对我却一无所知。我难过你没有给我同等的在意。", v: 2}] },
  { id: 10, text: "带伴侣去参加你的朋友聚会。整个过程中，你最舒服的状态是？", opts: [{t: "“连体婴”模式。 我不希望把他晾在一边。哪怕跟别人聊天，我也希望我们是站在一起的，或者眼神时不时能对上。", v: 1}, {t: "“得体”模式。 我比较在意他能不能融入。希望他表现大方、说话得体，别冷场也别出格。", v: 3}, {t: "“放养”模式。 最好是各玩各的。 我聊我的天，他找他的乐子，不用我时刻照顾他的情绪。", v: 6}, {t: "“低调”模式。 正常社交就好，千万别让我们成为全场的焦点。", v: 7}] },
  { id: 11, text: "两个人一起出去旅行，最容易让你心里炸毛的瞬间是？", opts: [{t: "由于对方磨蹭或出错，导致赶不上车/景点关门。 这种因为人为失误搞砸计划的感觉，会让我瞬间暴躁。", v: 3}, {t: "行程变来变去。 一会儿要去这一会儿要去那，完全没有章法。我需要知道今天到底要干嘛，而不是在街上瞎晃。", v: 8}, {t: "被行程表催着走。 出来玩就是为了放松，如果非要打卡、几点必须起床，那这就不是旅行，是军训。", v: 6}, {t: "同路不同频。我想跟他感叹一下风景的震撼，他却一脸漠然，或者只关心等会儿吃什么。这比一个人旅行更寂寞。", v: 5}] },
  { id: 12, text: "同居或长相处时，伴侣有一些让你看不惯的生活习惯（比如乱丢袜子、熬夜）。你通常会怎么想？", opts: [{t: "“没有规矩。” 家里必须有基本的整洁标准，如果大家都随心所欲，这个家就乱套了，我没法忍受混乱的环境。", v: 8}, {t: "“他不重视我。” 我都说过好几次了让他改，他还是这样。是不是我说的话他根本没放在心上？", v: 1}, {t: "“别管我就行。” 只要他不强迫我也跟着他乱，或者别反过来管我，我懒得因为这点破事吵架。", v: 6}, {t: "“还是我来吧。” 骂归骂，最后还是我默默帮他收拾了。", v: 2}] },
  { id: 13, text: "伴侣无意中提起了一个优秀的异性朋友，言语间带着欣赏。你心里的第一反应是？", opts: [{t: "酸溜溜的。 哪怕知道没事，心里也膈应：你为什么要当着我的面夸别人？难道我不够好吗？", v: 4}, {t: "警铃大作。 我会开始对比：那个人是不是比我更适合他？我是不是有被替代的风险？这种危机感让我很不安。", v: 1}, {t: "想搞清楚界限。 我不反感交友，但我需要确认他们现在到底是什么关系？有没有越界？这一切是否在可控范围内？", v: 3}, {t: "无所谓、装傻。 只要别影响我就行。我不太想深究他们的过去，也不想表现得像个嫉妒狂，太难看了。", v: 7}] },
  { id: 14, text: "在一起久了，关系进入一种“左手摸右手”的平淡模式，每天除了吃饭睡觉没别的话题。你会觉得？", opts: [{t: "这是一种慢性死亡。 如果没有了思想交流，没有了火花，这段关系只剩下一个空壳，哪怕日子安稳，也让我觉得索然无味。", v: 5}, {t: "有点失落。 以前他总是围着我转，现在他回家就玩手机，好像我这个人在不在家对他来说都没差别了。", v: 2}, {t: "求之不得。 终于到了这一步！不用每天费劲维系激情，各干各的事，这种空气般的相处才是最舒服的。", v: 6}, {t: "这很正常。 激情总会褪去，现在这种稳定的、可预测的生活节奏，反而让我觉得很踏实，日子就是这样过的。", v: 8}] },
  { id: 15, text: "你有一个非常痴迷的小爱好（比如拼模型、追星、某种运动），但伴侣完全不感兴趣。你希望他的态度是？", opts: [{t: "别干涉我。 这是我的自留地，请你也离远点。不需要你理解，只要别在我玩的时候在旁边指手画脚就行。", v: 7}, {t: "尊重我的投入。 我花在这个上面的时间、金钱是经过计算的，我有分寸。别总质疑我不务正业。", v: 3}, {t: "试着懂我一点。 你可以不玩，但如果你能明白为什么这个东西能打动我，我会很开心。", v: 5}, {t: "陪我一起玩。 哪怕你不喜欢，我也希望你能为了我试着参与一下。看着你陪我做我喜欢的事，我会觉得很幸福。", v: 4}] },
  { id: 16, text: "大吵一架终于和好了。为了让这页彻底翻过去，你最需要的一个“收尾动作”是？", opts: [{t: "反复确认。 我可能会忍不住再问几次：“你真的不生气了吗？”“我们真的没事了吗？”直到听到肯定的回答。", v: 1}, {t: "某种补偿行为。 比如给他做顿好吃的，或者对他格外好一点。", v: 2}, {t: "彻底不提。 既然和好了，就赶紧回归正常，把这尴尬的一页揭过去最好。", v: 7}, {t: "得到一个小惊喜。 不管谁对谁错，如果他能在这个时候给我买个小礼物或者带我吃顿好的就好了。", v: 4}] },
  // Part 2: 情绪暗涌
  { id: 17, text: "在一段关系里，最让你感到心慌、不踏实的那种时刻，其实是？", opts: [{t: "不知道下一秒会发生什么。 这种内心悬空的感觉最折磨人，我宁愿你直接判我死刑，也不要让我猜你到底还爱不爱我。", v: 1}, {t: "感觉透不过气。不管我走到哪、干什么，好像都有双眼睛盯着我，那种被严密包裹的窒息感，让我只想逃。", v: 6}, {t: "事情脱离了轨迹。明明说好的事突然变了，或者局面完全乱套了，这种无法把握方向的感觉让我非常焦躁。", v: 3}, {t: "像在演独角戏。 无论我表达什么，都像掉进了黑洞，没有任何反馈。这种两个人面对面、心却连不上的孤独感，比激烈的争吵更让我绝望。", v: 5}] },
  { id: 18, text: "当你在感情里觉得特别委屈时，脑海里那个挥之不去的念头是？", opts: [{t: "“好像我没什么价值。” 我做了这么多，你却觉得理所当然，甚至根本不需要。那种觉得自己很多余的感觉最伤人。", v: 2}, {t: "“我就知道会受伤。” 只要一靠近就会有风险，我刚才那一瞬间的脆弱被你无视了，这让我本能地想立刻缩回去。", v: 7}, {t: "“这不公平。” 为什么总是我在妥协？为什么规则对我不适用？这种不对等的付出让我觉得非常憋屈。", v: 8}, {t: "“原来我和别人没区别。” 我以为对你来说我是特别的，但刚才那个细节告诉我，我并没有被你放在那个例外的位置上。", v: 4}] },
  { id: 19, text: "你理想中最好的爱，给你的直接感觉应该是？", opts: [{t: "轻松。 没有压力，没有强制要求。我想粘你的时候就粘，想一个人待着你也觉得没问题，不用时刻紧绷着。", v: 6}, {t: "踏实。 不管发生什么，我都清楚地知道你不会走。那种心里有底、不用患得患失的感觉，最让我舒服。", v: 1}, {t: "默契。 是一种不用费劲解释的轻松。我可以把脑子里最真实、甚至最奇怪的想法直接抛给你，不用担心你接不住。", v: 5}, {t: "清晰。 我们知道未来去哪，也知道现在该干嘛。一切都在计划中稳步推进，这种井井有条的感觉最好。", v: 3}] },
  { id: 20, text: "当伴侣非常用力地黏着你、时刻都要和你在一起时，你的真实感受是？", opts: [{t: "很踏实。 这说明你真的很依赖我。我很享受这种“被你完全信任、完全依靠”的感觉，这证明了我在你生活里是不可替代的。", v: 2}, {t: "很想躲。太近了，这种高密度的亲密让我觉得不自在，甚至是种打扰。我需要一点时间回血，别逼太紧。", v: 7}, {t: "有点烦。 亲密可以，但要有分寸。如果连我的工作和正常生活节奏都被打乱了，我会觉得你很不懂事。", v: 8}, {t: "很受用。 嘴上可能说“烦死了”，但心里其实暗爽。这种非我不可的劲儿，最能证明你爱我。", v: 4}] },
  { id: 21, text: "两个人坐在一起不说话时，你心里的真实活动是？", opts: [{t: "很难受。 如果连话都懒得说，那我们在一起还有什么意思？这种精神上的断连，让我觉得我们像陌生人。", v: 5}, {t: "很慌张。 我会忍不住猜：他为什么不说话？是不是生气了？是不是对我厌倦了？这种未知让我坐立难安。", v: 1}, {t: "很舒服。 各玩各的手机，互不干扰，这种松弛感才是最高级的相处。", v: 6}, {t: "很想找点事做。 我不喜欢这种不知道该干嘛的冷场。与其尴尬地坐着，不如找个话题或者安排点事，打破这个僵局。", v: 3}] },
  { id: 22, text: "如果你在这段关系里付出了很多，你最害怕的结果是？", opts: [{t: "怕你是真的不需要。 我不怕累，但我怕我给你的东西，对你来说是个负担，或者是可有可无的废品。", v: 2}, {t: "怕这只是我的一厢情愿。 感情是双向的，如果只有我一个人在投入，那这就不是爱，是消耗。", v: 8}, {t: "怕你把这当成理所应当。 我对你好是因为我爱你，但如果你连一点特殊的感动都没有，我会瞬间心寒。", v: 4}, {t: "怕被赖上。我怕我一旦开了头，你就会索取更多，我不想因此背上某种很重的义务。", v: 7}] },
  { id: 23, text: "当听到“永远”这个词的时候，你下意识的反应是？", opts: [{t: "松了一口气。 虽然知道未来很难说，但我现在就是太需要这句话了。它能压住我心里所有的不安。", v: 1}, {t: "压力好大。 还没发生的事就先锁死，这让我觉得很沉重。比起承诺“永远”，我更希望“当下开心就好”。", v: 6}, {t: "听听就行。 别光说好听的，关键看你怎么做。没有具体行动支撑的“永远”，对我来说就是一张空头支票。", v: 3}, {t: "很多余。 真正的契合是不需要用时间来担保的。如果我们真的同频，“永远”就是一个自然而然的结果。", v: 5}] },
  { id: 24, text: "在激烈的争吵中，最让你感到绝望、甚至想放弃的一瞬间是？", opts: [{t: "是他推开我的时候。 当他说“不用你管”或者“离我远点”时，我觉得自己像个被丢弃的垃圾。", v: 2}, {t: "是他开始胡搅蛮缠的时候。 当逻辑失效，沟通变成纯粹的情绪发泄，没有任何道理可讲，我觉得这架吵得毫无意义。", v: 8}, {t: "是他站在我对立面的时候。 哪怕我有错，但当你表示帮理不帮亲的时候，我觉得全世界都背叛了我。", v: 4}, {t: "是他逼我立刻说话的时候。 你越逼问“你说话啊”，我越想把自己封闭起来。那种被逼到死角的窒息感，最让我绝望。", v: 7}] },
  { id: 25, text: "哪怕此时此刻什么都没发生，但只要想到这件事，你就会觉得非常有安全感：", opts: [{t: "我知道你会坚定地站在我这边。 不管发生什么风雨，我都清楚地知道你不会权衡利弊，也不会动摇。", v: 1}, {t: "我知道一切都在计划内。 我们的财务、未来规划都是清晰可见的，没有那些乱七八糟的突发状况来打乱生活。", v: 3}, {t: "我知道我是不可替代的。 不是生活上的依赖，而是我能给你别人给不了的快乐或支撑，我在你生命有独特位置。", v: 2}, {t: "我知道我随时可以做自己。 我不需要为了维持关系而伪装或讨好，在你面前我不用戴面具。", v: 6}] },
  { id: 26, text: "如果回想一段失败的感情，最让你觉得“意难平”或者“很受伤”的点可能是？", opts: [{t: "“我居然不是特别的。” 原来我费尽心思去爱，最后在你眼里，我和前任、和其他人也没什么两样。", v: 4}, {t: "“我们从未真正交流过。” 哪怕在一起很久，你也没懂过我哪怕一次。我们像两个住在同一个屋檐下的陌生人。", v: 5}, {t: "“付出没有回报。” 我投入了那么多时间和精力，最后却是一笔烂账，这种严重的不对等让我觉得很亏。", v: 8}, {t: "“我不该全盘托出。” 我后悔把自己最脆弱的一面展示给你看，结果成了你后来攻击我的武器。", v: 7}] },
  { id: 27, text: "你会因为什么事情而产生强烈的嫉妒心或占有欲？", opts: [{t: "当他遇到麻烦却不找我时。 明明我是你最亲近的人，你却去找了外人解决。", v: 2}, {t: "当他对谁都很好的时候。如果你的温柔没有门槛，那它在我这里就一文不值。", v: 4}, {t: "当他有事瞒着我时。 我不一定要干涉，但我必须知情，被蒙在鼓里让我抓狂。", v: 3}, {t: "当他和别人聊得更嗨时。 看到他和别人聊那些跟我聊不起来的话题，还两眼放光，我会觉得属于我的领地被侵犯了。", v: 5}] },
  { id: 28, text: "伴侣出差或不在家，留你一个人独处一周。你的真实感受是？", opts: [{t: "像放假一样爽。 终于不用照顾别人的情绪，不用配合别人的时间。我想几点睡几点睡，这种完全属于自己的时间太珍贵了。", v: 6}, {t: "逐渐开始慌张。 没人说话，家里太安静，我会开始忍不住看手机，期待他发消息过来，确认他还在意我。", v: 1}, {t: "非常自在。 我本来就需要很多独处时间来充电。这种互不打扰的状态，反而让我觉得我们的关系更健康了。", v: 7}, {t: "有点无所适从。 我习惯了把你放在优先级里，时刻想着你的事。突然只需要顾我自己，这种轻飘飘、没重量的感觉，反而让我觉得生活特别不真实。", v: 2}] },
  { id: 29, text: "如果伴侣做了这件事，你会瞬间下头，甚至考虑分手？", opts: [{t: "言而无信。 说好的事变卦，承诺的不兑现。如果连基本的契约精神都没有，这日子没法过。", v: 8}, {t: "拒绝沟通。 当我想聊聊问题，你却说“想太多”或者直接回避。这种拒绝进入我内心的态度，是我的死穴。", v: 5}, {t: "制造混乱。 总是惹麻烦让我收拾烂摊子，或者做事毫无章法搞得生活一团糟，这种“猪队友”我带不动。", v: 3}, {t: "权衡利弊。 如果在关键时刻，你犹豫了，或者为了别的东西牺牲了我的利益，那我绝对不会原谅。", v: 4}] },
  { id: 30, text: "如果给你自己写一份“恋爱使用说明书”，你最希望标注的核心法则是？", opts: [{t: "“请坚定地选择我。” 别犹豫，别摇摆，让我看到你选择我的决心，而不是总让我猜。", v: 1}, {t: "“请允许我做自己。” 别打着“为你好”的名义来改造我，爱我就请接受我原本的样子，包括我的缺点。", v: 6}, {t: "“请看见我的付出。”  看见我的付出，看见我的辛苦。别把一切都当成空气，夸我一句有那么难吗？", v: 2}, {t: "“请给我一点时间。” 别一上来就掏心掏肺，也别逼我马上回应。给我点时间，我才能慢慢打开。", v: 7}] },
  { id: 31, text: "如果让你用一个词来定义你理想中的“关系形态”，你希望你们是？", opts: [{t: "合伙人。 账目分明，分工明确，大家遵守同一个规则，为了共同的未来高效努力。", v: 8}, {t: "船长与领航员。 有明确的方向，有问题能迅速解决。无论风浪多大，这艘船必须在我们的控制之中。", v: 3}, {t: "灵魂伴侣。 哪怕一句话不说，眼神一对就知道对方在想什么。这种不需要磨合的默契，是我唯一的追求。", v: 5}, {t: "两条平行的河。 我们流向同一个大海，但我们有各自的河道。既有交集，又互不吞没，保持各自的完整。", v: 6}] },
  { id: 32, text: "在你看来，一个人爱你的最高级表现是？", opts: [{t: "例外。 他对世界冷漠，唯独对我不一样。这种“排他性”的温柔，才是最高级的爱。", v: 4}, {t: "托底。 无论我变成什么样，或者闯了什么祸，我知道他永远会站在我身后，不会抛弃我。", v: 1}, {t: "依赖。 他愿意把最脆弱、最无助的一面展示给我看，只让我一个人照顾他，这说明他完全把心交给了我。", v: 2}, {t: "尊重。 他从不强迫我改变，也不窥探我的隐私。他懂得站在安全线以外守护我，这种分寸感最打动我。", v: 7}] },
  // Part 3: 灵魂图腾
  { id: 33, text: "如果要把你向往的亲密关系画成一幅画，它最像什么？", opts: [{t: "深深扎进土里的树根。 无论地表风雨多大，地下永远紧紧纠缠，谁也拔不走。", v: 1}, {t: "两朵飘在天上的云。 我们在同一片天空，偶尔重叠，偶尔分开，聚散都随风，轻盈且自由。", v: 6}, {t: "一条笔直的高速公路。 视野开阔，路标清晰，我们握着方向盘，全速驶向同一个终点。", v: 3}, {t: "两面互相照映的镜子。 我看着你，就能看见最深处的自己。这种无声的映照，就是最深的懂得。", v: 5}] },
  { id: 34, text: "如果要把自己比喻成一种动物，在爱人面前，你更像？", opts: [{t: "温顺的大金毛。 我不需要做什么惊天动地的事，你随时感受到陪伴和暖意，我就觉得很满足。", v: 2}, {t: "被驯服的小狐狸。 世上有千千万万只狐狸，但我才对你来说是独一无二的。我只认你这一个“驯养员”。", v: 4}, {t: "屯松果的松鼠。 我喜欢未雨绸缪，一点点把我们的窝填满，规划好过冬的粮食。这种踏实感，是我爱你的方式。", v: 8}, {t: "林间的小鹿。 我生性敏感，如果你愿意站在原地安静地等，我会慢慢试探着靠近你。", v: 7}] },
  { id: 35, text: "闭上眼，你觉得最让你感到安稳的那个空间是？", opts: [{t: "暴雨夜的屋子。 外面狂风大作，屋内灯火通明。你在身边，门窗紧闭，这就是全世界最安全的地方。", v: 1}, {t: "巨大的落地窗。 视野通透，没有围栏。我不希望被墙壁困住，我需要随时能走出去的呼吸感。", v: 6}, {t: "深夜书房。 安静，私密，只有书和思想。我们可以一整晚不睡觉，只谈论灵魂，这是精神的庇护所。", v: 5}, {t: "私有王国。 关上门，这里就是我们的国度。外面的混乱无效，只有我们制定的规则。", v: 3}] },
  { id: 36, text: "如果关系出现危机，你觉得那场景最像什么？", opts: [{t: "荒原。 我拼命呼喊，想要付出，却发现周围空无一人，我的爱变成了没有回声的荒草。", v: 2}, {t: "沼泽。 我被拽住了，越挣扎陷得越深。那种无法抽身的黏腻感，是我最大的噩梦。", v: 7}, {t: "废墟。 原本搭建好的规则、承诺全部崩塌，满地狼藉，一切都失去了原本的逻辑。", v: 8}, {t: "大卖场。 我被放在货架上，和别人打折出售。那种廉价感和可替代感，会瞬间摧毁我。", v: 4}] },
  { id: 37, text: "如果“誓言”是一个具体的物品，你希望它是什么？", opts: [{t: "磐石。 够重、够硬、搬不走。 誓言不该是轻飘飘的话，而是一块压在那里的石头，以此镇住生活中所有的变数。", v: 1}, {t: "风铃。 悦耳，但不沉重。风来时它会响，风走时它静止。它美在当下的回应，而不是永久的束缚。", v: 6}, {t: "契约。 白纸黑字。 它代表的不是浪漫，而是两个清醒的成年人，在理智状态下达成的、不可违背的守则。", v: 3}, {t: "潮汐。 是引力，不是努力。 月亮不需要对大海发誓，潮水也会如约而至。这种不言自明的必然性，才是誓言。", v: 5}] },
  { id: 38, text: "你最喜欢的亲密关系，它的“温度”应该是？", opts: [{t: "滚烫的 100°C。 我喜欢那种沸腾的热情，那种全心全意扑上去的炙热，哪怕会被烫伤也在所不惜。", v: 2}, {t: "微凉的 20°C。 像秋天的风，清爽、不黏人。既不冷漠，也不让人觉得燥热难耐，这才是最长久的。", v: 7}, {t: "恒温的 26°C。 我不要忽冷忽热，我要的是稳定。不管是春夏秋冬，永远保持在这个最舒适的刻度。", v: 8}, {t: "只暖一人的 37°C。它是隐秘的、私有的，是只有我才有资格触碰的特权。", v: 4}] },
  { id: 39, text: "如果爱是一件必须随身携带的物品，你觉得它最像？", opts: [{t: "贴身的护身符。 平时可能感觉不到它的存在，但遇到危险或不安时，摸到它就在那里。", v: 1}, {t: "降噪耳机。 戴上它，世界的嘈杂瞬间消失，只能听到我们想听的旋律。", v: 5}, {t: "瑞士军刀。 精密、锋利、多功能。不管生活抛来什么乱七八糟的难题，我们都能拿它解决。", v: 3}, {t: "一张空白机票。 没有目的地，没有返程日。爱给了我底气，让我去探索更广阔的世界。", v: 6}] },
  { id: 40, text: "如果有一天真的要分开，你希望那是？", opts: [{t: "燃尽。 我像蜡烛一样流干了最后一滴泪，直到再也没有东西可以给你了，我才甘心离场。", v: 2}, {t: "退潮。 没有激烈的争吵，只是自然而然地退去。水面恢复平静，像什么都没发生过一样。", v: 7}, {t: "清算。 我们坐下来，把账算清，把话说开。有一个明确的句号，而不是一个潦草的省略号。", v: 8}, {t: "绝版。 我走之后，你会永远怀念我，因为你再也遇不到像我这样对你好的人了。", v: 4}] },
  { id: 41, text: "你最喜欢的恋爱氛围，像哪种天气？", opts: [{t: "多云有风。 空气是流动的，云是散漫的。没有暴晒的太阳，也没有压抑的雨，清清爽爽，适合散步。", v: 6}, {t: "初雪。 世界突然变得很安静，只剩下白色。这种纯粹、浪漫、又有点稀缺的氛围，最让我心动。", v: 4}, {t: "晴朗无云。 能见度极高，一眼能看到地平线。没有突如其来的雷阵雨，一切都清晰、明朗、可预测。", v: 8}, {t: "深夜雷雨。 窗外狂风暴雨，我们躲在屋里。这种与世隔绝、只有我们俩相依为命的深刻感，最让我着迷。", v: 5}] },
  { id: 42, text: "如果你闭上眼触摸“爱”，手感应该是？", opts: [{t: "晒热的石头。 厚实、干燥、有温度。它并不柔软，但有一种沉甸甸的分量。", v: 1}, {t: "湿软的陶泥。 柔软、依恋。它会填满我指缝的每一处空隙，完全顺应我的力度。", v: 2}, {t: "流动的溪水。 清凉、无重力。它流经我的皮肤，带来触感却不带来负担。", v: 7}, {t: "紧绷的缰绳。 粗糙、有力、有摩擦感。它连接着前方的力量，握住它，我就能控制方向。", v: 3}] },
  { id: 43, text: "你觉得一段好的亲密关系，闻起来应该像？", opts: [{t: "薄荷或海盐。 清冽、透气。吸进去能让肺部扩张，而不是那种甜腻到让人头晕的香水味。", v: 6}, {t: "草莓尖尖。 是那第一口咬下去的甜，带着露水，是特供的、精选的、只留给我的那部分。", v: 4}, {t: "刚晒干的棉被。 干净、干燥、阳光的味道。没有发霉的阴影，只有一种井井有条的生活气息。", v: 8}, {t: "旧书页/焚香。 沉静、悠长。不是为了取悦感官，而是能让人瞬间静下来，闻到时间的味道。", v: 5}] },
  { id: 44, text: "你希望爱人是哪种光源？", opts: [{t: "壁炉里的火。 它需要我不停地添柴，但它能照亮整个屋子。我是那个守护火种的人。", v: 2}, {t: "灯塔。 它是固定的。不管我航行到哪里，只要回头看，那一束光永远在那个位置扫射，从未熄灭。", v: 1}, {t: "月光。 它是温柔的，但也是清冷的。它照亮我，但不会像正午的太阳那样灼伤我。", v: 7}, {t: "手里的火把。 它不靠天赐，而是靠我亲手点燃。我不祈求天亮，我要亲自为你劈开黑暗、照亮前路。", v: 3}] },
  { id: 45, text: "如果把与爱人的相处节奏比作一段旋律，你希望它是？", opts: [{t: "时钟的声音。 滴答滴答，精准、规律。我们按时吃饭，按时睡觉，按部就班地走完这一生。", v: 8}, {t: "随口的哼唱。 没有固定的曲调，也不为了表演。就像散步时随口哼出的小调，断断续续、轻轻松松。", v: 6}, {t: "山谷里的回音。 你发出的每一个声音，无论多微弱，都能在我这里得到回应。因为我们也正好想唱同一首歌。", v: 5}, {t: "为你独奏。 聚光灯打在你身上，而我在为你演奏。那一刻，全世界都是背景音，只有我们是彼此的主角。", v: 4}] },
  { id: 46, text: "如果爱必须伴随一种痛，你宁愿是？", opts: [{t: "生长痛。 像骨骼拉伸一样，虽然酸痛，但说明我们在付出、在羁绊，关系是成长的。", v: 2}, {t: "钝痛。 哪怕关系变得乏味、沉重，也好过那种“不知明天你还在不在”的剧烈撕裂痛。", v: 1}, {t: "幻痛。 哪怕分开了，你也像我身体的一部分。但我宁愿隔着距离怀念，也不愿靠太近互相伤害。", v: 7}, {t: "剥离痛。 像撕开粘在身上的面具和伪装。那种把最真实的软肋赤裸裸暴露给你的恐惧和疼痛，是我们抵达灵魂深处的代价。", v: 5}] },
  { id: 47, text: "如果要把你们共度的时间比作一样东西，它应该是？", opts: [{t: "流沙。 抓得越紧流得越快，不如摊开手掌。让它自然流淌，顺其自然。", v: 6}, {t: "沙漏。 时间是可控的，哪怕流完了，我们也有能力把它倒过来，重新开始下一轮。", v: 3}, {t: "琥珀。 把最美的那一瞬间封存起来，永远晶莹剔透，不被外界的灰尘侵蚀。", v: 4}, {t: "年轮。 一圈一圈，扎扎实实。不管发生什么，每一年都会留下一圈清晰的印记。", v: 8}] },
  { id: 48, text: "最后，请凭直觉填空：爱是______。", opts: [{t: "定数。 是万物流变的世界里，唯一不会更改、也不会撤回的那个答案。", v: 1}, {t: "认出。 是我们在嘈杂的茫茫人海里，精准地辨认出——彼此是唯一的同类。", v: 5}, {t: "成全。 是我们并不互相捆绑，却因此在彼此身边，拥有了更广阔的天空。", v: 6}, {t: "治愈。 是看见了你的破碎，而我甘愿成为那贴唯一有效的药。", v: 2}] }
];

// ==========================================
// 3. 核心交互组件
// ==========================================

export default function App() {
  const [view, setView] = useState('landing');
  const [code, setCode] = useState('');
  const [errorMsg, setErrorMsg] = useState('');
  const [loading, setLoading] = useState(false);
  
  const [qIndex, setQIndex] = useState(0);
  const [scores, setScores] = useState({});
  const [selectedOpt, setSelectedOpt] = useState(null);
  const [transitionText, setTransitionText] = useState('');
  const [finalResult, setFinalResult] = useState(null);
  const [expandedSection, setExpandedSection] = useState(0); // 默认展开第一个详情

  // 1. 初始化检查缓存
  useEffect(() => {
    const savedResult = localStorage.getItem('psy_result');
    if (savedResult) {
      setFinalResult(JSON.parse(savedResult));
      setView('result');
      return;
    }
    const savedProgress = localStorage.getItem('psy_progress');
    if (savedProgress) {
      const { index, currentScores } = JSON.parse(savedProgress);
      setQIndex(index);
      setScores(currentScores);
      setView('onboarding'); // 回到说明页
    }
  }, []);

  // 2. 验证兑换码
  const handleVerify = async () => {
    if (!code.trim()) return;
    setLoading(true);
    setErrorMsg('');
    try {
      const cleanCode = code.trim().toUpperCase();
      const { data, error } = await supabase
        .from('codes')
        .select('*')
        .eq('code', cleanCode)
        .single();

      if (error || !data) throw new Error('无效的兑换码，请检查输入');
      if (data.is_used) throw new Error('此码已被使用，请勿重复验证');

      await supabase.from('codes').update({ is_used: true }).eq('id', data.id);
      await wait(800);
      setView('onboarding');
    } catch (err) {
      setErrorMsg(err.message);
    } finally {
      setLoading(false);
    }
  };

  // 3. 处理答题
  const handleAnswer = async (val, idx) => {
    if (selectedOpt !== null) return;
    setSelectedOpt(idx);
    
    await wait(350); // 选中反馈停留

    const newScores = { ...scores, [val]: (scores[val] || 0) + 1 };
    setScores(newScores);
    
    const nextIdx = qIndex + 1;
    localStorage.setItem('psy_progress', JSON.stringify({ index: nextIdx, currentScores: newScores }));

    // Part 转场检测
    let transMsg = '';
    if (nextIdx === 16) transMsg = "现实切片已完成\n意识表层正在剥离...";
    if (nextIdx === 32) transMsg = "情绪暗涌已穿越\n准备进入灵魂图腾...";

    if (transMsg) {
      setTransitionText(transMsg);
      setView('transition');
      await wait(3000);
      setQIndex(nextIdx);
      setSelectedOpt(null);
      setView('quiz');
    } else if (nextIdx < QUESTIONS.length) {
      setQIndex(nextIdx);
      setSelectedOpt(null);
    } else {
      finishQuiz(newScores);
    }
  };

  // 4. 返回上一题
  const handleBack = () => {
    if (qIndex > 0) {
      setQIndex(qIndex - 1);
      setSelectedOpt(null);
    }
  };

  // 5. 计算结果
  const finishQuiz = async (finalScores) => {
    setView('calculating');
    localStorage.removeItem('psy_progress');
    await wait(2500);

    let maxScore = -1;
    let maxId = 1;
    Object.entries(finalScores).forEach(([id, score]) => {
      if (score > maxScore) {
        maxScore = score;
        maxId = id;
      }
    });

    const res = RESULTS[maxId];
    // 补全 totem 和 color 信息
    res.totem = DIM_MAP[maxId].totem;
    res.color = DIM_MAP[maxId].color;
    
    setFinalResult(res);
    localStorage.setItem('psy_result', JSON.stringify(res));
    setView('result');
  };

  // 6. 获取当前 Part 名称
  const getPartName = () => {
    if (qIndex < 16) return "Part 1 现实切片";
    if (qIndex < 32) return "Part 2 情绪暗涌";
    return "Part 3 灵魂图腾";
  };

  // ==========================================
  // 4. 视图渲染
  // ==========================================
  return (
    <div className="app-root">
      <Head>
        <title>情感欲望测量 | 柚子心理</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
        <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet" />
      </Head>

      {/* --- 落地页 --- */}
      {view === 'landing' && (
        <div className="view-center fade-in">
          <div className="hero">
            <div className="brand">柚子的心理小屋 原创</div>
            <h1 className="title">情感欲望测量</h1>
            <p className="subtitle">DEEP PSYCHOLOGY TEST</p>
            <div className="line" />
            <p className="desc">48道深度切片 · 识别你的亲密底色</p>
          </div>
          <div className="input-area">
            <input 
              value={code} 
              onChange={e => setCode(e.target.value)}
              placeholder="请输入兑换码"
              className="code-input"
            />
            <button 
              className={`btn-main ${loading ? 'disabled' : ''}`}
              onClick={handleVerify}
            >
              {loading ? '验证中...' : '解锁测试'}
            </button>
            {errorMsg && <p className="error">{errorMsg}</p>}
            <a href="https://xiaohongshu.com" className="link">如何获得兑换码？</a>
          </div>
        </div>
      )}

      {/* --- 说明页 --- */}
      {view === 'onboarding' && (
        <div className="view-center fade-in">
          <div className="card">
            <h2 className="card-title">潜入前知悉</h2>
            <div className="info-row"><span className="icon">⏳</span>全程约 10-15 分钟</div>
            <div className="info-row"><span className="icon">🌊</span>经历：现实/情绪/灵魂 三阶段</div>
            <div className="info-row"><span className="icon">🤫</span>请凭直觉作答，无需思考</div>
            <button className="btn-main mt-8" onClick={() => setView('quiz')}>
              {qIndex > 0 ? `继续进度 (${qIndex}/48)` : '开始潜入'}
            </button>
          </div>
        </div>
      )}

      {/* --- 答题页 --- */}
      {view === 'quiz' && (
        <div className="view-quiz fade-in">
          <div className="top-bar">
            {qIndex > 0 && <button className="back-btn" onClick={handleBack}>←</button>}
            <span className="part-name">{getPartName()}</span>
            <span className="progress-num">{qIndex + 1} / 48</span>
          </div>
          <div className="progress-line">
            <div className="fill" style={{width: `${(qIndex+1)/48*100}%`}}></div>
          </div>
          
          <div className="question-area">
            <h3 className="q-text slide-up" key={`q-${qIndex}`}>{QUESTIONS[qIndex].text}</h3>
            <div className="opts-col">
              {QUESTIONS[qIndex].opts.map((opt, idx) => (
                <div 
                  key={idx} 
                  className={`opt-card ${selectedOpt === idx ? 'selected' : ''}`}
                  onClick={() => handleAnswer(opt.v, idx)}
                >
                  <span className="opt-t">{opt.t}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* --- 转场页 --- */}
      {view === 'transition' && (
        <div className="view-center fade-in">
          <p className="trans-text pulse">{transitionText}</p>
        </div>
      )}

      {/* --- 计算页 --- */}
      {view === 'calculating' && (
        <div className="view-center">
          <div className="spinner" />
          <p className="trans-text">正在生成情感图谱...</p>
        </div>
      )}

      {/* --- 结果页 --- */}
      {view === 'result' && finalResult && (
        <div className="view-result fade-in">
          {/* 海报区 */}
          <div className="poster">
            <div className="poster-top">YOUR EMOTIONAL DESIRE</div>
            <h1 className="res-title" style={{color: finalResult.color}}>{finalResult.title}</h1>
            <div className="totem-pill">
              <span>✦</span>{finalResult.totem}
            </div>
            <p className="quote">“{finalResult.quote}”</p>
            <div className="keyword">{finalResult.keyword}</div>
          </div>

          {/* 详情区 */}
          <div className="details">
            {finalResult.sections.map((sec, idx) => (
              <div key={idx} className="accordion-item">
                <div 
                  className="acc-head" 
                  onClick={() => setExpandedSection(expandedSection === idx ? -1 : idx)}
                >
                  <span className="acc-title">{sec.t}</span>
                  <span className="acc-icon">{expandedSection === idx ? '-' : '+'}</span>
                </div>
                {expandedSection === idx && (
                  <div className="acc-body fade-in">
                    <p>{sec.c}</p>
                  </div>
                )}
              </div>
            ))}
            
            <div className="actions">
              <button className="btn-outline" onClick={() => {
                alert('请截图本页面分享给好友');
              }}>保存结果卡片</button>
              <button className="btn-link" onClick={() => {
                localStorage.clear();
                window.location.reload();
              }}>重新测试</button>
            </div>
          </div>
        </div>
      )}

      {/* --- CSS --- */}
      <style jsx global>{`
        :root {
          --bg: #0F1115;
          --card-bg: rgba(255,255,255,0.05);
          --text-main: #E5E5E5;
          --text-sub: #9CA3AF;
          --accent: #FCD34D;
          --font: "Noto Serif SC", serif;
        }
        body { margin: 0; background: var(--bg); color: var(--text-main); font-family: -apple-system, sans-serif; }
        .app-root { min-height: 100vh; position: relative; overflow-x: hidden; }

        /* 通用布局 */
        .view-center { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .view-quiz { min-height: 100vh; padding: 0 20px; display: flex; flex-direction: column; }
        .view-result { min-height: 100vh; background: #000; }
        
        /* 动画 */
        .fade-in { animation: fadeIn 0.8s ease forwards; }
        .slide-up { animation: slideUp 0.5s ease forwards; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        @keyframes pulse { 0%,100%{opacity:0.6} 50%{opacity:1} }

        /* 落地页 */
        .brand { font-size: 12px; color: var(--text-sub); letter-spacing: 2px; margin-bottom: 20px; }
        .title { font-family: var(--font); font-size: 36px; font-weight: 300; margin: 0 0 10px; letter-spacing: 2px; }
        .subtitle { font-size: 10px; letter-spacing: 4px; opacity: 0.5; margin-bottom: 30px; }
        .line { width: 40px; height: 1px; background: var(--text-sub); opacity: 0.3; margin: 0 auto 30px; }
        .input-area { width: 100%; max-width: 320px; margin-top: 40px; }
        .code-input { width: 100%; background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1); padding: 15px; color: #fff; text-align: center; font-size: 16px; border-radius: 8px; margin-bottom: 15px; outline: none; }
        .btn-main { width: 100%; background: #fff; color: #000; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); }
        .btn-main.disabled { opacity: 0.6; pointer-events: none; }
        .error { color: #EF4444; font-size: 12px; margin-top: 10px; }
        .link { display: block; margin-top: 20px; color: var(--text-sub); font-size: 12px; text-decoration: underline; }

        /* 说明页 */
        .card { background: var(--card-bg); padding: 30px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 340px; text-align: left; }
        .card-title { font-family: var(--font); font-weight: 300; margin-bottom: 20px; text-align: center; }
        .info-row { margin-bottom: 15px; font-size: 14px; color: var(--text-sub); display: flex; align-items: center; }
        .icon { margin-right: 10px; }
        .mt-8 { margin-top: 32px; }

        /* 答题页 */
        .top-bar { height: 50px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: var(--text-sub); margin-top: 10px; }
        .back-btn { background: none; border: none; color: inherit; font-size: 18px; padding: 0 10px; }
        .progress-line { height: 1px; background: rgba(255,255,255,0.1); width: 100%; position: relative; margin-bottom: 30px; }
        .fill { height: 100%; background: #fff; transition: width 0.3s; }
        .question-area { max-width: 600px; margin: 0 auto; width: 100%; }
        .q-text { font-family: var(--font); font-size: 20px; line-height: 1.6; font-weight: 300; margin-bottom: 40px; }
        .opt-card { background: var(--card-bg); padding: 20px; margin-bottom: 16px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
        .opt-card:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        .opt-card.selected { border-color: var(--accent); background: rgba(255,255,255,0.1); }
        .opt-t { font-size: 15px; line-height: 1.5; color: #D4D4D4; }

        /* 转场 & 计算 */
        .trans-text { font-family: var(--font); font-size: 20px; line-height: 2; white-space: pre-line; color: var(--text-main); }
        .spinner { width: 40px; height: 40px; border: 2px solid rgba(255,255,255,0.1); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 结果页 */
        .poster { padding: 60px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); background: radial-gradient(circle at top, rgba(255,255,255,0.05), transparent 70%); }
        .poster-top { font-size: 10px; letter-spacing: 3px; opacity: 0.5; margin-bottom: 20px; }
        .res-title { font-family: var(--font); font-size: 42px; margin: 0 0 20px; letter-spacing: 2px; }
        .totem-pill { display: inline-flex; align-items: center; border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 50px; font-size: 12px; margin-bottom: 30px; gap: 8px; }
        .quote { font-family: var(--font); font-style: italic; opacity: 0.8; font-size: 15px; line-height: 1.6; max-width: 80%; margin: 0 auto 20px; }
        .keyword { font-size: 12px; letter-spacing: 2px; opacity: 0.5; }
        
        .details { padding: 40px 20px; max-width: 600px; margin: 0 auto; }
        .accordion-item { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .acc-head { padding: 20px 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .acc-title { font-size: 16px; font-weight: 500; color: #fff; }
        .acc-icon { font-size: 20px; font-weight: 300; opacity: 0.5; }
        .acc-body { padding-bottom: 20px; color: var(--text-sub); font-size: 14px; line-height: 1.8; white-space: pre-line; text-align: justify; }
        
        .actions { margin-top: 50px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .btn-outline { background: transparent; border: 1px solid #fff; color: #fff; padding: 12px 30px; border-radius: 50px; font-size: 14px; cursor: pointer; }
        .btn-link { background: none; border: none; color: var(--text-sub); text-decoration: underline; font-size: 12px; cursor: pointer; }
      `}</style>
    </div>
  );
}
